---
import Layout from '../../layouts/Layout.astro';
import LoginFormV2 from '../../components/Composed/Login/LoginFormV2.jsx';

// Handle form submission on server side
let errorMessage = '';
if (Astro.request.method === 'POST') {
	try {
		const data = await Astro.request.text();
		const params = new URLSearchParams(data);
		const username = params.get('username')?.trim() || '';
		const password = params.get('password')?.trim() || '';

		// Validate credentials
		if (!username || !password) {
			errorMessage = 'Please enter both email and password';
		} else if (username === 'admin' && password === 'admin') {
			// Set auth cookie for admin
			Astro.cookies.set('auth', JSON.stringify({ role: 'admin', username: 'admin' }), {
				secure: true,
				httpOnly: true,
				sameSite: 'strict',
				maxAge: 60 * 60 * 24, // 24 hours
			});
			return Astro.redirect('/DashboardAdmin');
		} else if (username === 'user' && password === 'user') {
			// Set auth cookie for regular user
			Astro.cookies.set('auth', JSON.stringify({ role: 'user', username: 'user' }), {
				secure: true,
				httpOnly: true,
				sameSite: 'strict',
				maxAge: 60 * 60 * 24, // 24 hours
			});
			return Astro.redirect('/DashboardUser');
		} else {
			errorMessage = 'Invalid credentials. Try admin/admin or user/user';
		}
	} catch (error) {
		errorMessage = 'Error processing the form. Please try again.';
	}
}
---

<Layout title="Login">
	<LoginFormV2 client:load errorMessage={errorMessage} />
</Layout>
